{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}UNIQUE - Orders{% endblock %}

{% block content %}
{{ customers|json_script:"customer_json" }}
{{ products|json_script:"products_json" }}

<main>
  <h1>Orders</h1>

  <form class="order-form" method="POST" id="orderForm">
    {% csrf_token %}

    <!-- Hidden Fields -->
    <input type="hidden" name="customer_id" id="customer_id">
    <input type="hidden" name="gst_number" id="gst_number" value="{{ profile.gst_number|default:'' }}">
    <input type="hidden" name="items_json" id="items_json">
    <input type="hidden" name="total_amount" id="hiddenTotal">
    <input type="hidden" name="amount_paid" id="hiddenPaid">

    <!-- Customer Info -->
    <div class="form-group">
      <label for="customerPhone">Phone</label>
      <input type="text" id="customerPhone" value="N/A" readonly style="cursor: pointer;" title="Click to change customer" data-customer-id="">
    </div>

    <div class="form-group">
      <label for="customerGST">GST No.</label>
      <input type="text" id="customerGST" readonly value="N/A">
    </div>

    {% if editing %}
      <input type="hidden" id="editing-sale-id" value="{{ sale.id }}">
    {% endif %}

    <!-- Branch (Admin Only) -->
    {% if profile.role == 'admin' %}
      <div class="form-group">
        <label for="branchSelect">Select Branch</label>
        <select id="branchSelect" required>
          {% for b in branches %}
            <option value="{{ b.id }}">{{ b.name }} - {{ b.location }}</option>
          {% endfor %}
        </select>
      </div>
    {% else %}
      <input type="hidden" id="branchSelect" value="{{ branch_id }}">
    {% endif %}

    <!-- Items -->
    <div class="form-group" style="grid-column: span 2;">
      <label>Items</label>
      <div id="itemList"></div>
      <button class="btn" type="button" onclick="addItemRow()" style="margin-top: 1rem;">+ Add Item</button>
    </div>

    <div class="form-group">
      <label for="itemPrice">Item Price (‚Çπ)</label>
      <input type="number" id="itemPrice" value="0" readonly>
    </div>

    <div class="form-group">
      <label for="itemQty">No. of Items</label>
      <input type="number" id="itemQty" min="1" value="1" required>
    </div>

    <div class="form-group">
      <label for="totalAmount">Total Amount</label>
      <input type="number" id="totalAmount" readonly value="0">
    </div>

    <div class="form-group">
      <label for="grandTotal">Grand Total</label>
      <input type="number" id="grandTotal" readonly value="0">
    </div>

    <div class="form-group">
      <label for="totalWithGST">Total (Incl. GST)</label>
      <input type="number" id="totalWithGST" readonly value="0">
    </div>

    <div class="form-group">
      <label for="amountPaid">Amount Paid</label>
      <input type="number" id="amountPaid" required>
    </div>

    <button type="submit" class="btn">Place Order</button>
    <button type="button" class="btn" onclick="showReceipt()">View Receipt</button>
  </form>

  <!-- Selected Customer Info -->
  <div class="customer-info" id="selectedCustomerBox">
    <h3>Customer Details</h3>
    <p><strong>Name:</strong> <span id="custName">‚Äî</span></p>
    <p><strong>Phone:</strong> <span id="custPhone">‚Äî</span></p>
    <p><strong>GST No:</strong> <span id="custGST">‚Äî</span></p>
  </div>
</main>

<!-- Customer Modal -->
<div class="modal-overlay" id="customerModal">
  <div class="customer-modal">
    <h3>Select a Customer</h3>
    <button class="add-customer-btn" type="button">+ Add Customer</button>
    <select id="modalCustomerSelect"></select>
    <div class="customer-details">
      <p><strong>Phone:</strong> <span id="modalPhone">‚Äî</span></p>
      <p><strong>GST No:</strong> <span id="modalGST">‚Äî</span></p>
    </div>
    <div class="modal-buttons">
      <button onclick="closeCustomerModal()">Cancel</button>
      <button class="proceed-btn" onclick="proceedToOrder()">Proceed</button>
    </div>
  </div>
</div>

<!-- Add Customer Modal -->
<div class="modal-overlay" id="addCustomerModal" style="display: none;">
  <div class="customer-modal">
    <h3>Add New Customer</h3>
    <input type="hidden" id="branchId" value="{{ branch_id }}">
    <div class="form-group">
      <label for="newCustomerName">Name</label>
      <input type="text" id="newCustomerName" required>
    </div>
    <div class="form-group">
      <label for="newCustomerPhone">Phone</label>
      <input type="text" id="newCustomerPhone" required>
    </div>
    <div class="form-group">
      <label for="newCustomerGST">GST Number</label>
      <input type="text" id="newCustomerGST">
    </div>
    <div class="modal-buttons">
      <button onclick="closeAddCustomerModal()">Cancel</button>
      <button onclick="saveNewCustomer()">Save</button>
    </div>
  </div>
</div>

<!-- Receipt Modal -->
<div class="modal-overlay" id="receiptModal">
  <div class="customer-modal" style="max-width: 600px; background: #fdfdfd;">
    <div style="text-align: center; margin-bottom: 1rem;">
      <img src="{% static 'images/logo.png' %}" alt="UNIQUE Store Logo" style="height: 60px;">
      <h3 style="margin: 0;">üßæ UNIQUE STORE</h3>
      <p style="font-size: 0.9rem;">123 Main Street, Kolkata - 700001<br>Phone: +91-9876543210</p>
    </div>

    <div style="font-size: 0.95rem; line-height: 1.6;">
      <p><strong>Date:</strong> <span id="rDate">‚Äî</span></p>
      <p><strong>Customer:</strong> <span id="rName">‚Äî</span></p>
      <p><strong>Phone:</strong> <span id="rPhone">‚Äî</span></p>
      <p><strong>GST No:</strong> <span id="rGST">‚Äî</span></p>
      <p><strong>GST Details:</strong> GST included item-wise below.</p>
      <hr>
      <div id="rItems" style="margin-bottom: 1rem;"></div>
      <hr>
      <p><strong>Total (Incl. GST):</strong> ‚Çπ<span id="rGrand">0.00</span></p>
      <p><strong>Paid:</strong> ‚Çπ<span id="rPaid">0.00</span></p>
    </div>

    <div class="modal-buttons">
      <button onclick="closeReceiptModal()">Close</button>
      <button onclick="printReceipt()">üñ®Ô∏è Print Receipt</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Load customers dynamically
  const CUSTOMERS = JSON.parse(document.getElementById('customer_json').textContent);
  const select = document.getElementById("modalCustomerSelect");
  CUSTOMERS.forEach(cust => {
    const option = document.createElement("option");
    option.value = cust.id;
    option.textContent = cust.name;
    option.dataset.phone = cust.phone;
    option.dataset.gst = cust.gst || '';
    select.appendChild(option);
  });
</script>

<!-- Scripts -->
<script src="{% static 'dashboard/js/customer.js' %}" defer></script>
<script src="{% static 'dashboard/js/customer-modal.js' %}" defer></script>
<script src="{% static 'dashboard/js/order-form.js' %}" defer></script>
<script src="{% static 'dashboard/js/receipt-modal.js' %}" defer></script>
{% endblock %}
